<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InvoiceVault</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --ink: #0d1117;
      --ink3: #2d3748;
      --surface: #f7f8fa;
      --card: #ffffff;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent2: #1d4ed8;
      --green: #059669;
      --amber: #d97706;
      --red: #dc2626;
      --purple: #7c3aed;
      --muted: #64748b;
      --tag-bg: #eff6ff;
      --tag-txt: #1d4ed8;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, .07);
      --shadow-lg: 0 12px 40px rgba(0, 0, 0, .13);
      --radius: 14px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--surface);
      color: var(--ink);
      min-height: 100vh;
      font-size: 15px
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: var(--ink);
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 62px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(0, 0, 0, .3)
    }

    .logo {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 20px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px
    }

    .hdr-right {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .hdr-btn {
      background: rgba(255, 255, 255, .1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .2);
      padding: 7px 14px;
      border-radius: var(--radius-sm);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: .2s;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .hdr-btn:hover {
      background: rgba(255, 255, 255, .18)
    }

    .hdr-btn.primary {
      background: var(--accent);
      border-color: var(--accent)
    }

    .hdr-btn.primary:hover {
      background: var(--accent2)
    }

    /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
    .nav-tabs {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      display: flex;
      overflow-x: auto
    }

    .nav-tab {
      padding: 14px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: .2s;
      display: flex;
      align-items: center;
      gap: 7px;
      margin-bottom: -1px;
      white-space: nowrap
    }

    .nav-tab:hover {
      color: var(--ink)
    }

    .nav-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent)
    }

    .tab-count {
      background: var(--tag-bg);
      color: var(--tag-txt);
      font-size: 11px;
      padding: 1px 7px;
      border-radius: 10px;
      font-weight: 600
    }

    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px
    }

    .tab-pane {
      display: none
    }

    .tab-pane.active {
      display: block
    }

    /* ‚îÄ‚îÄ KPI ‚îÄ‚îÄ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 28px
    }

    .kpi-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 22px 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%
    }

    .kpi-card.blue::before {
      background: var(--accent)
    }

    .kpi-card.green::before {
      background: var(--green)
    }

    .kpi-card.amber::before {
      background: var(--amber)
    }

    .kpi-card.purple::before {
      background: var(--purple)
    }

    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .7px;
      margin-bottom: 8px
    }

    .kpi-value {
      font-family: 'Syne', sans-serif;
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px
    }

    .kpi-sub {
      font-size: 12px;
      color: var(--muted)
    }

    /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 28px
    }

    @media(max-width:860px) {
      .charts-grid {
        grid-template-columns: 1fr
      }
    }

    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow-sm)
    }

    .chart-title {
      font-family: 'Syne', sans-serif;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 16px
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 5px;
      height: 150px
    }

    .bar-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      flex: 1;
      min-width: 0
    }

    .bar {
      width: 100%;
      background: linear-gradient(180deg, var(--accent), #60a5fa);
      border-radius: 5px 5px 0 0;
      min-height: 4px;
      transition: opacity .2s;
      cursor: default
    }

    .bar:hover {
      opacity: .8
    }

    .bar-label {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%
    }

    .bar-val {
      font-size: 10px;
      font-weight: 600;
      color: var(--ink3);
      white-space: nowrap
    }

    .client-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9
    }

    .client-row:last-child {
      border-bottom: none
    }

    .client-name {
      font-size: 14px;
      font-weight: 500;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    .client-bar-wrap {
      flex: 2;
      background: #f1f5f9;
      border-radius: 4px;
      height: 7px;
      overflow: hidden
    }

    .client-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--accent), #60a5fa)
    }

    .client-amount {
      font-family: 'Syne', sans-serif;
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap
    }

    /* ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ */
    .upload-zone {
      background: var(--card);
      border: 2.5px dashed var(--border);
      border-radius: var(--radius);
      padding: 56px 32px;
      text-align: center;
      cursor: pointer;
      transition: .2s;
      margin-bottom: 24px
    }

    .upload-zone:hover,
    .upload-zone.drag-over {
      border-color: var(--accent);
      background: var(--tag-bg)
    }

    .upload-icon {
      font-size: 52px;
      margin-bottom: 14px
    }

    .upload-title {
      font-family: 'Syne', sans-serif;
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 8px
    }

    .upload-sub {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 22px
    }

    .upload-btn-inner {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 30px;
      border-radius: var(--radius-sm);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer
    }

    .upload-btn-inner:hover {
      background: var(--accent2)
    }

    #fileInput {
      display: none
    }

    .queue-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px
    }

    .queue-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn .2s ease
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-6px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .q-filename {
      font-weight: 500;
      font-size: 14px;
      flex: 1
    }

    .q-status {
      font-size: 13px;
      color: var(--muted)
    }

    .sdot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0
    }

    .sdot.proc {
      background: var(--amber);
      animation: pulse 1s infinite
    }

    .sdot.done {
      background: var(--green)
    }

    .sdot.err {
      background: var(--red)
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .3
      }
    }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .table-wrap {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      overflow: hidden
    }

    .table-toolbar {
      padding: 13px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap
    }

    .search-box {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 13px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      width: 220px;
      outline: none;
      transition: .2s
    }

    .search-box:focus {
      border-color: var(--accent)
    }

    .filter-sel {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      outline: none;
      background: var(--card);
      cursor: pointer
    }

    .t-count {
      font-size: 13px;
      color: var(--muted);
      margin-left: auto
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    thead {
      background: #f8fafc
    }

    th {
      padding: 10px 15px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .6px;
      color: var(--muted);
      text-align: left;
      border-bottom: 1px solid var(--border);
      white-space: nowrap
    }

    td {
      padding: 12px 15px;
      font-size: 14px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle
    }

    tr:last-child td {
      border-bottom: none
    }

    tr:hover td {
      background: #fafbfc
    }

    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500
    }

    .bb {
      background: #eff6ff;
      color: #1d4ed8
    }

    .bg {
      background: #f0fdf4;
      color: #15803d
    }

    .bp {
      background: #f5f3ff;
      color: #6d28d9
    }

    .ba {
      background: #fffbeb;
      color: #92400e
    }

    .amt {
      font-family: 'Syne', sans-serif;
      font-weight: 600
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 15px;
      padding: 4px 7px;
      border-radius: 6px;
      transition: .15s;
      color: #bbb
    }

    .icon-btn:hover.del {
      color: var(--red);
      background: #fff1f2
    }

    .icon-btn:hover.edit {
      color: var(--accent);
      background: var(--tag-bg)
    }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .mo {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: .2s
    }

    .mo.open {
      opacity: 1;
      pointer-events: all
    }

    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 30px;
      width: 580px;
      max-width: 95vw;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      transform: scale(.96);
      transition: .2s
    }

    .mo.open .modal {
      transform: scale(1)
    }

    .modal-hdr {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 22px
    }

    .modal-title {
      font-family: 'Syne', sans-serif;
      font-size: 19px;
      font-weight: 700
    }

    .modal-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 22px;
      color: var(--muted);
      padding: 4px;
      border-radius: 6px
    }

    .modal-close:hover {
      background: #f1f5f9
    }

    .dg {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px
    }

    .dl {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .6px;
      color: var(--muted);
      margin-bottom: 3px
    }

    .dv {
      font-size: 15px;
      font-weight: 500
    }

    .full {
      grid-column: 1/-1
    }

    .edit-input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      outline: none;
      transition: .2s
    }

    .edit-input:focus {
      border-color: var(--accent)
    }

    .save-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: var(--radius-sm);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 16px
    }

    .save-btn:hover {
      background: var(--accent2)
    }

    .lit {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px
    }

    .lit th {
      background: #f8fafc;
      padding: 7px 10px;
      font-weight: 600;
      text-align: left;
      border: 1px solid var(--border)
    }

    .lit td {
      padding: 6px 10px;
      border: 1px solid var(--border)
    }

    /* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
    .empty {
      text-align: center;
      padding: 55px 20px;
      color: var(--muted)
    }

    .empty-icon {
      font-size: 50px;
      margin-bottom: 12px
    }

    .empty-title {
      font-family: 'Syne', sans-serif;
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--ink3)
    }

    .empty-sub {
      font-size: 14px
    }

    /* ‚îÄ‚îÄ INFO BANNER ‚îÄ‚îÄ */
    .info-banner {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      line-height: 1.5
    }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--ink);
      color: #fff;
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      z-index: 999;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transform: translateY(8px);
      transition: .25s;
      pointer-events: none
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0)
    }

    .toast.ok::before {
      content: '‚úì ';
      color: #4ade80
    }

    .toast.err::before {
      content: '‚úï ';
      color: #f87171
    }

    /* section title */
    .stitle {
      font-family: 'Syne', sans-serif;
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 14px
    }

    @media(max-width:600px) {
      main {
        padding: 14px
      }

      .kpi-grid {
        grid-template-columns: 1fr 1fr
      }

      .kpi-value {
        font-size: 22px
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">
      <div class="logo-icon">üìÅ</div>InvoiceVault
    </div>
    <div class="hdr-right">
      <a class="hdr-btn primary" href="/api/export">‚¨á Export CSV</a>
      <a class="hdr-btn" href="/api/logout" style="background:var(--red);border-color:var(--red)">üîí Logout</a>
    </div>
  </header>

  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
    <div class="nav-tab" onclick="switchTab('upload')">‚¨Ü Upload PDFs</div>
    <div class="nav-tab" onclick="switchTab('invoices')">üìÑ All Invoices <span class="tab-count" id="invCount">0</span>
    </div>
    <div class="nav-tab" onclick="switchTab('monthly')">üìÖ Monthly</div>
    <div class="nav-tab" onclick="switchTab('clients')">üë• Clients</div>
  </div>

  <main>

    <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
    <div class="tab-pane active" id="tab-dashboard">
      <div class="kpi-grid">
        <div class="kpi-card blue">
          <div class="kpi-label">Total Revenue</div>
          <div class="kpi-value" id="k-rev">$0</div>
          <div class="kpi-sub">CAD ¬∑ All time</div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-label">Invoices</div>
          <div class="kpi-value" id="k-cnt">0</div>
          <div class="kpi-sub">Processed</div>
        </div>
        <div class="kpi-card amber">
          <div class="kpi-label">Avg Invoice</div>
          <div class="kpi-value" id="k-avg">$0</div>
          <div class="kpi-sub">CAD ¬∑ Per invoice</div>
        </div>
        <div class="kpi-card purple">
          <div class="kpi-label">Clients</div>
          <div class="kpi-value" id="k-cli">0</div>
          <div class="kpi-sub">Unique</div>
        </div>
        <div class="kpi-card-mini"
          style="background:var(--card);border-radius:var(--radius);padding:22px 24px;box-shadow:var(--shadow-sm);border:1px solid var(--border);position:relative;overflow:hidden;border-left:4px solid var(--green)">
          <div class="kpi-label">Gross Profit</div>
          <div class="kpi-value" id="k-profit" style="color:var(--green)">$0</div>
          <div class="kpi-sub">CAD ¬∑ All time</div>
        </div>
        <div class="kpi-card-mini"
          style="background:var(--card);border-radius:var(--radius);padding:22px 24px;box-shadow:var(--shadow-sm);border:1px solid var(--border);position:relative;overflow:hidden;border-left:4px solid var(--accent)">
          <div class="kpi-label">Avg Margin</div>
          <div class="kpi-value" id="k-margin" style="color:var(--accent)">0%</div>
          <div class="kpi-sub">Weighted avg</div>
        </div>
      </div>
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Monthly Revenue</div>
          <div class="bar-chart" id="barChart"></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Top Clients</div>
          <div id="cliChart"></div>
        </div>
      </div>
      <div class="stitle">Recent Invoices</div>
      <div class="table-wrap" id="recentTable"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê UPLOAD ‚ïê‚ïê‚ïê -->
    <div class="tab-pane" id="tab-upload">
      <div class="info-banner">
        üí° <div><strong>How it works:</strong> Upload a PDF invoice ‚Äî the app reads the text directly from the file and
          extracts amounts, dates, and client names automatically. If anything is wrong, you can fix it by clicking ‚úèÔ∏è
          on any invoice. <strong>No internet connection needed for extraction ‚Äî 100% free.</strong></div>
      </div>
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()"
        ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
        <div class="upload-icon">üì§</div>
        <div class="upload-title">Drop invoice PDFs here</div>
        <div class="upload-sub">Or click to browse ‚Äî supports multiple files at once</div>
        <button class="upload-btn-inner"
          onclick="event.stopPropagation();document.getElementById('fileInput').click()">Choose PDFs</button>
      </div>
      <input type="file" id="fileInput" accept=".pdf" multiple onchange="handleFiles(event)">
      <div id="queueWrap" style="display:none">
        <div class="stitle">Processing</div>
        <div class="queue-list" id="queueList"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê ALL INVOICES ‚ïê‚ïê‚ïê -->
    <div class="tab-pane" id="tab-invoices">
      <div class="table-wrap">
        <div class="table-toolbar">
          <input class="search-box" id="searchBox" placeholder="üîç Search client, invoice #..."
            oninput="renderInvTable()">
          <select class="filter-sel" id="yrFilter" onchange="renderInvTable()">
            <option value="">All years</option>
          </select>
          <select class="filter-sel" id="moFilter" onchange="renderInvTable()">
            <option value="">All months</option>
          </select>
          <select class="filter-sel" id="catFilter" onchange="renderInvTable()">
            <option value="">All Categories</option>
            <option value="Inventory">Inventory</option>
            <option value="Utilities">Utilities</option>
            <option value="Software">Software</option>
            <option value="Fuel">Fuel</option>
            <option value="Marketing">Marketing</option>
            <option value="Rent">Rent</option>
            <option value="General">General</option>
          </select>
          <span class="t-count" id="tCount"></span>
        </div>
        <div id="invTableBody"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MONTHLY ‚ïê‚ïê‚ïê -->
    <div class="tab-pane" id="tab-monthly">
      <div id="monthlyContent"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CLIENTS ‚ïê‚ïê‚ïê -->
    <div class="tab-pane" id="tab-clients">
      <div id="clientsContent"></div>
    </div>

  </main>

  <!-- ‚ïê‚ïê‚ïê DETAIL / EDIT MODAL ‚ïê‚ïê‚ïê -->
  <div class="mo" id="mo" onclick="closeMo(event)">
    <div class="modal">
      <div class="modal-hdr">
        <div class="modal-title" id="moTitle">Invoice</div>
        <button class="modal-close" onclick="closeMoDirect()">‚úï</button>
      </div>
      <div id="moContent"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- pdf.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATE & HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let invoices = [];
    const RATES = { CAD: 1, USD: 1.38, EUR: 1.48, GBP: 1.76 }; // Approx rates for normalization

    function toCAD(val, cur) {
      return val * (RATES[cur] || 1);
    }

    function checkRecurring() {
      const clients = {};
      invoices.forEach(i => {
        const c = i.clientName; if (!c) return;
        if (!clients[c]) clients[c] = new Set();
        clients[c].add(`${i.year}-${i.month}`);
      });
      return Object.entries(clients)
        .filter(([name, months]) => months.size >= 2)
        .map(([name]) => name);
    }

    async function loadData() {
      try {
        const r = await fetch('/api/invoices');
        const data = await r.json();
        if (Array.isArray(data)) {
          invoices = data;
        } else {
          console.error('Unexpected data from server:', data);
          invoices = [];
          if (data && data.error) showToast('Server Error: ' + data.error, 'err');
        }
      } catch (err) {
        console.error('Load error:', err);
        invoices = [];
      }
      refresh();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TABS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function switchTab(name) {
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-' + name).classList.add('active');
      const tabs = ['dashboard', 'upload', 'invoices', 'monthly', 'clients'];
      document.querySelectorAll('.nav-tab')[tabs.indexOf(name)].classList.add('active');
      if (name === 'invoices') renderInvTable();
      if (name === 'monthly') renderMonthly();
      if (name === 'clients') renderClients();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  UPLOAD & PDF PARSING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function handleDragOver(e) { e.preventDefault(); document.getElementById('uploadZone').classList.add('drag-over'); }
    function handleDragLeave() { document.getElementById('uploadZone').classList.remove('drag-over'); }
    function handleDrop(e) { e.preventDefault(); handleDragLeave(); processFiles([...e.dataTransfer.files]); }
    function handleFiles(e) { processFiles([...e.target.files]); e.target.value = ''; }

    async function processFiles(files) {
      const pdfs = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
      if (!pdfs.length) { showToast('Please upload PDF files only', 'err'); return; }
      document.getElementById('queueWrap').style.display = 'block';
      for (const file of pdfs) {
        const qid = 'q' + Date.now() + Math.random().toString(36).slice(2);
        addQueueItem(qid, file.name);
        try {
          const text = await readPDF(file);
          console.log('--- RAW PDF TEXT (' + file.name + ') ---');
          console.log(text);
          console.log('--- END RAW TEXT ---');
          setQStatus(qid, 'proc', 'Extracting data...');
          const inv = parseInvoice(text, file.name);
          await saveToServer(inv);
          invoices.unshift(inv);
          refresh();
          setQStatus(qid, 'done', `‚úì ${inv.clientName || 'Unknown'} ‚Äî $${fmt(inv.total)}`);
          showToast(file.name + ' processed!', 'ok');
        } catch (e) {
          setQStatus(qid, 'err', '‚úï ' + e.message);
          showToast('Error: ' + e.message, 'err');
        }
      }
    }

    // ‚îÄ‚îÄ Read all text from a PDF using pdf.js ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function readPDF(file) {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      let fullText = '';

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const items = content.items;
        if (!items.length) continue;

        // Group by Y coordinate with 5px tolerance
        const linesMap = {};
        for (const item of items) {
          const y = Math.round(item.transform[5]);
          let foundY = Object.keys(linesMap).find(ly => Math.abs(ly - y) <= 5);
          if (!foundY) {
            foundY = y;
            linesMap[foundY] = [];
          }
          linesMap[foundY].push(item);
        }

        // Sort lines from top to bottom
        const sortedY = Object.keys(linesMap).sort((a, b) => b - a);

        for (const y of sortedY) {
          const lineItems = linesMap[y].sort((a, b) => a.transform[4] - b.transform[4]);
          let lineText = '';
          let lastX = -1;
          let lastWidth = 0;

          for (const item of lineItems) {
            const x = item.transform[4];
            if (lastX !== -1) {
              const gap = x - (lastX + lastWidth);
              // Add spaces based on gap size
              if (gap > 30) lineText += '    ';
              else if (gap > 10) lineText += '  ';
              else lineText += ' ';
            }
            lineText += item.str;
            lastX = x;
            lastWidth = item.width || (item.str.length * 5); // Fallback width estimation
          }
          if (lineText.trim()) fullText += lineText.trim() + '\n';
        }
        fullText += '\n';
      }
      return fullText;
    }

    // ‚îÄ‚îÄ Parser ‚Äî tuned for GB Wholesale + general Canadian invoices ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function parseInvoice(text, filename) {
      const find = (patterns) => {
        for (const p of patterns) {
          const m = text.match(p);
          if (m && m[1] && m[1].trim()) return m[1].trim();
        }
        return null;
      };

      // ‚îÄ‚îÄ Invoice number
      // Handles: "INVOICE # 17818", "Invoice #17818", "INV-001"
      const invoiceNumber = find([
        /invoice\s*#\s*(\d+)/i,
        /invoice\s*(?:number|no\.?)\s*[:\-]?\s*([A-Z0-9][A-Z0-9\-\/]{1,20})/i,
        /inv\s*[#no.]*\s*[:\-]?\s*([A-Z0-9][A-Z0-9\-\/]{1,20})/i,
        /#\s*([0-9]{3,10})\b/,
      ]);

      // ‚îÄ‚îÄ Client name
      // Handles: "Bill To : PIONEER", "Bill To: Acme Corp"
      const clientName = find([
        /bill\s+to\s*[:\s]+([A-Z][A-Z0-9 &'.,-]{1,50}?)(?:\n|$)/i,
        /bill(?:ed)?\s+to[:\s]*\n\s*([A-Za-z][^\n]{2,50})/i,
        /client\s*[:\-]\s*([^\n]{2,50})/i,
        /customer\s*[:\-]\s*([^\n]{2,50})/i,
        /sold\s+to[:\s]*\n?\s*([A-Za-z][^\n]{2,50})/i,
      ]);

      // ‚îÄ‚îÄ Date
      // Your format is DD/MM/YYYY (05/02/2026 = Feb 5). We detect this.
      const rawDate = find([
        /date\s*[:\-]\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})/i,
        /invoice\s+date\s*[:\-]\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})/i,
        /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/,
        /(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/,
      ]);

      const dateObj = parseDate(rawDate);
      const dateISO = dateObj ? fmtDateISO(dateObj) : null;
      const year = dateObj ? dateObj.getFullYear() : new Date().getFullYear();
      const month = dateObj ? dateObj.getMonth() + 1 : new Date().getMonth() + 1;
      const MNAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const monthName = MNAMES[month - 1];
      const quarter = 'Q' + Math.ceil(month / 3);

      // ‚îÄ‚îÄ Amounts
      // Priority order: most specific label first
      const total = findAmount(text, [
        /\bTOTAL\b[\s\$]*([\d,]+\.\d{2})/,           // "TOTAL $ 2,462.04"
        /total\s+due[^$\d]*([\d,]+\.\d{2})/i,
        /amount\s+due[^$\d]*([\d,]+\.\d{2})/i,
        /grand\s+total[^$\d]*([\d,]+\.\d{2})/i,
      ]);
      const subtotal = findAmount(text, [
        /SUBTOTAL[\s\$]*([\d,]+\.\d{2})/,             // "SUBTOTAL $ 2,178.80"
        /sub[\s\-]?total[^$\d]*([\d,]+\.\d{2})/i,
      ]);
      const tax = findAmount(text, [
        /SALES\s+TAX[\s\$]*([\d,]+\.\d{2})/,          // "SALES TAX $ 283.24"
        /HST[\s\$]*([\d,]+\.\d{2})/,
        /GST[\s\$]*([\d,]+\.\d{2})/,
        /VAT[\s\$]*([\d,]+\.\d{2})/,
        /tax\s+amount[^$\d]*([\d,]+\.\d{2})/i,
      ]);

      // ‚îÄ‚îÄ Payment method (bonus field for your invoices)
      const paymentMethod = find([
        /paid\s+by\s*[:\-]?\s*([A-Za-z ]+?)(?:\n|$)/i,
      ]);

      // ‚îÄ‚îÄ HST number (Canadian)
      const hstNumber = find([
        /hst\s+no\.?\s*[:\-]?\s*([0-9A-Z ]+?)(?:\n|$)/i,
      ]);

      // ‚îÄ‚îÄ Currency ‚Äî Canadian invoices use CAD
      const currency = text.includes('HST') || text.includes('hst') ? 'CAD'
        : /¬£/.test(text) ? 'GBP' : /‚Ç¨/.test(text) ? 'EUR' : 'USD';

      // ‚îÄ‚îÄ Auto-Categorization Logic
      const AUTO_CATEGORIES = {
        'Inventory': ['wholesale', 'stock', 'bulk', 'pallet', 'case of', 'qty'],
        'Utilities': ['hydro', 'gas', 'electric', 'water', 'internet', 'bell', 'rogers', 'cogeco'],
        'Software': ['adobe', 'microsoft', 'aws', 'google', 'subscription', 'monthly fee', 'license'],
        'Fuel': ['esso', 'petro', 'shell', 'gasoline', 'diesel', 'fuel', 'station'],
        'Marketing': ['ads', 'facebook', 'instagram', 'promotion', 'flyer', 'print'],
        'Rent': ['rent', 'lease', 'storage', 'warehouse'],
      };

      let category = 'General';
      for (const [cat, keywords] of Object.entries(AUTO_CATEGORIES)) {
        if (keywords.some(k => text.toLowerCase().includes(k))) {
          category = cat;
          break;
        }
      }

      // ‚îÄ‚îÄ Line items
      const lineItems = extractLineItems(text);

      return {
        id: 'inv_' + Date.now() + '_' + Math.random().toString(36).slice(2),
        fileName: filename,
        uploadedAt: new Date().toISOString(),
        invoiceNumber, clientName, date: dateISO,
        year, month, monthName, quarter,
        subtotal: subtotal || (total && tax ? +(total - tax).toFixed(2) : 0),
        tax: tax || 0,
        total: total || 0,
        currency,
        category,
        paymentMethod: paymentMethod || null,
        hstNumber: hstNumber || null,
        lineItems,
        rawTextPreview: text.slice(0, 500),
      };
    }

    function fmtDateISO(d) {
      // Returns YYYY-MM-DD without timezone shift issues
      return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0');
    }

    function findAmount(text, patterns) {
      for (const p of patterns) {
        const m = text.match(p);
        if (m && m[1]) {
          const n = parseFloat(m[1].replace(/,/g, ''));
          if (!isNaN(n) && n > 0) return n;
        }
      }
      return 0;
    }

    function extractLineItems(text) {
      const items = [];
      const lines = text.split('\n');

      const parseAmt = (s) => parseFloat((s || '').replace(/[$\s,]/g, '')) || 0;
      const isAmt = (s) => /^\d+([,.]\d+)?$/.test((s || '').replace(/[$\s,]/g, ''));

      for (const line of lines) {
        const cleanLine = line.trim();
        if (!cleanLine || cleanLine.includes('SUBTOTAL') || cleanLine.includes('TOTAL')) continue;

        // Pattern A: Qty at start, then desc, then prices (standard GB Wholesale)
        const mA = cleanLine.match(/^(\d+(?:\.\d+)?)\s+(.{3,60}?)\s+[\$]?\s*([\d,]+(?:\.\d+)?)\s+[\$]?\s*([\d,]+(?:\.\d+)?)\s*$/);
        if (mA) {
          items.push({ description: mA[2].trim(), quantity: parseAmt(mA[1]), unitPrice: parseAmt(mA[3]), amount: parseAmt(mA[4]) });
          continue;
        }

        // Pattern B: Desc at start, then qty, unit price, total at end
        const mB = cleanLine.match(/^(.{3,40}?)\s+(\d+(?:\.\d+)?)\s+[\$]?\s*([\d,]+(?:\.\d+)?)\s+[\$]?\s*([\d,]+(?:\.\d+)?)\s*$/);
        if (mB) {
          items.push({ description: mB[1].trim(), quantity: parseAmt(mB[2]), unitPrice: parseAmt(mB[3]), amount: parseAmt(mB[4]) });
          continue;
        }

        // Pattern C: Generic column-based (look for 2+ space separation)
        const parts = cleanLine.split(/\s{2,}/);
        if (parts.length >= 3) {
          const last = parts[parts.length - 1].trim();
          const secondLast = parts[parts.length - 2].trim();

          if (isAmt(last) && isAmt(secondLast)) {
            const amount = parseAmt(last);
            const price = parseAmt(secondLast);
            let qty = 1, desc = '';

            if (parts.length >= 4) {
              const p0 = parts[0].trim();
              if (isAmt(p0) && !/[a-z]/i.test(p0)) {
                qty = parseAmt(p0);
                desc = parts.slice(1, parts.length - 2).join(' ');
              } else {
                desc = parts.slice(0, parts.length - 2).join(' ');
                const potentialQty = parseAmt(parts[parts.length - 3]);
                if (potentialQty > 0) qty = potentialQty;
              }
            } else {
              desc = parts.slice(0, parts.length - 2).join(' ');
            }
            if (desc.trim() && desc.length > 2) {
              items.push({ description: desc.trim(), quantity: qty, unitPrice: price, amount: amount });
            }
          }
        }
      }
      return items.slice(0, 40);
    }

    const MONTHS_MAP = { january: 0, february: 1, march: 2, april: 3, may: 4, june: 5, july: 6, august: 7, september: 8, october: 9, november: 10, december: 11, jan: 0, feb: 1, mar: 2, apr: 3, jun: 5, jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11 };

    function parseDate(raw) {
      if (!raw) return null;
      raw = raw.trim();
      let m;

      // YYYY-MM-DD  (unambiguous ISO)
      if ((m = raw.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/)))
        return new Date(+m[1], +m[2] - 1, +m[3]);

      // DD/MM/YYYY or MM/DD/YYYY  ‚Üê your invoices use DD/MM/YYYY
      if ((m = raw.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/))) {
        const a = +m[1], b = +m[2], yr = +m[3];
        // If first number > 12 it MUST be the day (DD/MM/YYYY)
        // Otherwise default to DD/MM/YYYY since this is a Canadian company
        const day = a, mo = b;
        const d = new Date(yr, mo - 1, day);
        return isNaN(d.getTime()) ? null : d;
      }

      // Month name formats: "February 5, 2026" or "5 February 2026"
      if ((m = raw.match(/^([A-Za-z]+)\s+(\d{1,2}),?\s+(\d{4})$/))) {
        const mo = MONTHS_MAP[m[1].toLowerCase()];
        if (mo !== undefined) return new Date(+m[3], mo, +m[2]);
      }
      if ((m = raw.match(/^(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})$/))) {
        const mo = MONTHS_MAP[m[2].toLowerCase()];
        if (mo !== undefined) return new Date(+m[3], mo, +m[1]);
      }
      return null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SERVER SYNC
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function saveToServer(inv) {
      const r = await fetch('/api/invoices', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(inv) });
      if (!r.ok) {
        let msg = 'Failed to save to server';
        try {
          const data = await r.json();
          if (data.error) msg = `Server Error: ${data.error}`;
        } catch (e) { }
        throw new Error(msg);
      }
    }

    async function deleteInvoice(id) {
      if (!confirm('Delete this invoice from history?')) return;
      await fetch('/api/invoices/' + id, { method: 'DELETE' });
      invoices = invoices.filter(i => i.id !== id);
      refresh(); renderInvTable();
      showToast('Invoice deleted', 'ok');
    }

    async function saveEdit(id) {
      const fields = ['invoiceNumber', 'clientName', 'date', 'total', 'subtotal', 'tax'];
      const body = {};
      fields.forEach(f => {
        const el = document.getElementById('edit_' + f);
        if (el) body[f] = f === 'total' || f === 'subtotal' || f === 'tax' ? parseFloat(el.value) || 0 : el.value;
      });

      // Collect line items
      const rows = document.querySelectorAll('#edit_lineItemsTable tbody tr');
      const lineItems = [];
      rows.forEach(r => {
        const inputs = r.querySelectorAll('input');
        const qty = parseFloat(inputs[1].value) || 0;
        const price = parseFloat(inputs[2].value) || 0;
        lineItems.push({
          description: inputs[0].value,
          quantity: qty,
          unitPrice: price,
          ourPrice: parseFloat(inputs[3].value) || 0,
          amount: +(qty * price).toFixed(2)
        });
      });
      body.lineItems = lineItems;
      // Recompute date fields
      const d = parseDate(body.date);
      if (d) {
        const MNAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        body.year = d.getFullYear();
        body.month = d.getMonth() + 1;
        body.monthName = MNAMES[d.getMonth()];
        body.quarter = 'Q' + Math.ceil((d.getMonth() + 1) / 3);
        body.date = d.toISOString().slice(0, 10);
      }
      const r = await fetch('/api/invoices/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const updated = await r.json();
      const idx = invoices.findIndex(i => i.id === id);
      if (idx >= 0) invoices[idx] = updated;
      closeMoDirect(); refresh(); renderInvTable();
      showToast('Invoice updated', 'ok');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  REFRESH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function refresh() {
      const n = invoices.length;
      document.getElementById('invCount').textContent = n;
      const total = invoices.reduce((s, i) => s + toCAD(i.total || 0, i.currency), 0);
      const avg = n ? total / n : 0;
      const clients = new Set(invoices.map(i => i.clientName).filter(Boolean)).size;

      // Profit calculation
      let totalProfit = 0;
      let profitEligibleTotal = 0;
      invoices.forEach(inv => {
        let invProfit = 0;
        (inv.lineItems || []).forEach(item => {
          const qty = item.quantity || 0;
          const price = item.unitPrice || 0;
          const cost = item.ourPrice || 0;
          if (cost > 0) {
            invProfit += (qty * price) - (qty * cost);
          }
        });
        totalProfit += invProfit;
        if (invProfit !== 0) profitEligibleTotal += toCAD(inv.subtotal || 0, inv.currency);
      });
      const avgMargin = profitEligibleTotal ? (totalProfit / profitEligibleTotal) * 100 : 0;

      // Identify recurring
      const recurring = checkRecurring();
      const recList = recurring.slice(0, 3).join(', ');

      document.getElementById('k-rev').textContent = '$' + fmt(total);
      document.getElementById('k-cnt').textContent = n;
      document.getElementById('k-avg').textContent = '$' + fmt(avg);
      document.getElementById('k-cli').textContent = clients;
      document.getElementById('k-profit').textContent = '$' + fmt(totalProfit);
      document.getElementById('k-margin').textContent = avgMargin.toFixed(1) + '%';

      // Bonus: add recurring info to revenue subtext if any
      if (recurring.length) {
        document.querySelector('.kpi-card.green .kpi-sub').innerHTML = `Processed ¬∑ <span title="${recurring.join(', ')}" style="color:var(--accent);cursor:help">${recurring.length} Recurring</span>`;
      }

      renderBarChart(); renderCliChart(); renderRecentTable(); populateFilters();
    }

    function renderBarChart() {
      const el = document.getElementById('barChart');
      if (!invoices.length) { el.innerHTML = emptyHTML('üìà', 'No data yet'); return; }
      const map = {};
      invoices.forEach(i => {
        if (!i.year || !i.month) return;
        const k = `${i.year}-${String(i.month).padStart(2, '0')}`;
        if (!map[k]) map[k] = { label: (i.monthName || '').slice(0, 3) + ' ' + i.year, total: 0 };
        map[k].total += i.total || 0;
      });
      const sorted = Object.values(map).sort((a, b) => a.label < b.label ? -1 : 1).slice(-12);
      const maxV = Math.max(...sorted.map(m => m.total)) || 1;
      el.innerHTML = sorted.map(m => `
    <div class="bar-col">
      <div class="bar-val">$${fmtK(m.total)}</div>
      <div class="bar" style="height:${Math.max(6, (m.total / maxV) * 130)}px" title="${m.label}: $${fmt(m.total)}"></div>
      <div class="bar-label">${m.label}</div>
    </div>`).join('');
    }

    function renderCliChart() {
      const el = document.getElementById('cliChart');
      if (!invoices.length) { el.innerHTML = emptyHTML('üë•', 'No data yet'); return; }
      const map = {};
      invoices.forEach(i => { const c = i.clientName || 'Unknown'; map[c] = (map[c] || 0) + (i.total || 0); });
      const sorted = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 7);
      const maxV = sorted[0]?.[1] || 1;
      el.innerHTML = sorted.map(([name, amt]) => `
    <div class="client-row">
      <div class="client-name">${name}</div>
      <div class="client-bar-wrap"><div class="client-bar-fill" style="width:${(amt / maxV) * 100}%"></div></div>
      <div class="client-amount">$${fmt(amt)}</div>
    </div>`).join('');
    }

    function renderRecentTable() {
      document.getElementById('recentTable').innerHTML = buildTable(invoices.slice(0, 8), false);
    }

    function renderInvTable() {
      const search = (document.getElementById('searchBox').value || '').toLowerCase();
      const yr = document.getElementById('yrFilter').value;
      const mo = document.getElementById('moFilter').value;
      const cat = document.getElementById('catFilter').value;
      let f = invoices.filter(i => {
        if (yr && String(i.year) !== yr) return false;
        if (mo && String(i.month) !== mo) return false;
        if (cat && i.category !== cat) return false;
        if (search) { const h = [i.clientName, i.invoiceNumber, i.date, i.fileName, i.category].join(' ').toLowerCase(); if (!h.includes(search)) return false; }
        return true;
      });
      document.getElementById('tCount').textContent = `${f.length} of ${invoices.length}`;
      document.getElementById('invTableBody').innerHTML = f.length ? buildTable(f, true) : emptyHTML('üîç', 'No results');
    }

    function buildTable(list, showAct) {
      if (!list.length) return emptyHTML('üìÑ', 'No invoices yet ‚Äî upload your first PDF!');
      return `<table><thead><tr>
    <th>Invoice #</th><th>Client</th><th>Category</th><th>Date</th><th>Quarter</th>
    <th>Subtotal (CAD)</th><th>Tax (HST)</th><th>Total (CAD)</th>${showAct ? '<th></th>' : ''}
  </tr></thead><tbody>
  ${list.map(i => `<tr style="cursor:pointer" onclick="showDetail('${i.id}')">
    <td><span class="badge bb">${i.invoiceNumber || '‚Äî'}</span></td>
    <td><strong>${i.clientName || 'Unknown'}</strong></td>
    <td><span class="badge ${i.category === 'Inventory' ? 'bp' : i.category === 'Utilities' ? 'ba' : 'bb'}">${i.category || 'General'}</span></td>
    <td>${i.date || '‚Äî'}</td>
    <td>${i.quarter ? `<span class="badge bp">${i.quarter} ${i.year || ''}</span>` : '‚Äî'}</td>
    <td class="amt">$${fmt(i.subtotal || 0)}</td>
    <td class="amt">$${fmt(i.tax || 0)}</td>
    <td class="amt" style="color:var(--green)">$${fmt(i.total || 0)}</td>
    ${showAct ? `<td style="white-space:nowrap">
      <button class="icon-btn edit" onclick="event.stopPropagation();openEdit('${i.id}')" title="Edit">‚úèÔ∏è</button>
      <button class="icon-btn del"  onclick="event.stopPropagation();deleteInvoice('${i.id}')" title="Delete">üóë</button>
    </td>`: ''}
  </tr>`).join('')}
  </tbody></table>`;
    }

    function renderMonthly() {
      const el = document.getElementById('monthlyContent');
      if (!invoices.length) { el.innerHTML = emptyHTML('üìÖ', 'No data yet'); return; }
      const map = {};
      invoices.forEach(i => {
        if (!i.year || !i.month) return;
        const k = `${i.year}-${String(i.month).padStart(2, '0')}`;
        if (!map[k]) map[k] = { year: i.year, month: i.month, monthName: i.monthName, quarter: i.quarter, count: 0, total: 0, sub: 0, tax: 0 };
        map[k].count++; map[k].total += i.total || 0; map[k].sub += i.subtotal || 0; map[k].tax += i.tax || 0;
      });
      const rows = Object.values(map).sort((a, b) => a.year === b.year ? a.month - b.month : a.year - b.year);
      const grand = rows.reduce((s, r) => s + r.total, 0);
      el.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Year</th><th>Quarter</th><th>Month</th><th># Invoices</th><th>Subtotal (CAD)</th><th>Tax (HST)</th><th>Total (CAD)</th><th>Share</th></tr></thead>
    <tbody>${rows.map(r => `<tr>
      <td>${r.year}</td>
      <td><span class="badge bp">${r.quarter || '‚Äî'}</span></td>
      <td><strong>${r.monthName || r.month}</strong></td>
      <td><span class="badge bb">${r.count}</span></td>
      <td>$${fmt(r.sub)}</td><td>$${fmt(r.tax)}</td>
      <td class="amt" style="color:var(--green)">$${fmt(r.total)}</td>
      <td><div style="display:flex;align-items:center;gap:8px">
        <div style="flex:1;background:#f1f5f9;border-radius:4px;height:6px;overflow:hidden">
          <div style="width:${grand ? (r.total / grand * 100) : 0}%;height:100%;background:var(--accent);border-radius:4px"></div>
        </div>
        <span style="font-size:12px;color:var(--muted)">${grand ? (r.total / grand * 100).toFixed(1) : 0}%</span>
      </div></td>
    </tr>`).join('')}</tbody>
    <tfoot><tr style="background:#f8fafc;font-weight:700">
      <td colspan="3" style="padding:11px 15px">TOTAL</td>
      <td style="padding:11px 15px">${rows.reduce((s, r) => s + r.count, 0)}</td>
      <td style="padding:11px 15px">$${fmt(rows.reduce((s, r) => s + r.sub, 0))}</td>
      <td style="padding:11px 15px">$${fmt(rows.reduce((s, r) => s + r.tax, 0))}</td>
      <td style="padding:11px 15px;color:var(--green)">$${fmt(grand)}</td>
      <td style="padding:11px 15px">100%</td>
    </tr></tfoot>
  </table></div>`;
    }

    function renderClients() {
      const el = document.getElementById('clientsContent');
      if (!invoices.length) { el.innerHTML = emptyHTML('üë•', 'No data yet'); return; }
      const map = {};
      invoices.forEach(i => {
        const c = i.clientName || 'Unknown';
        if (!map[c]) map[c] = { count: 0, total: 0, dates: [] };
        map[c].count++; map[c].total += i.total || 0; if (i.date) map[c].dates.push(i.date);
      });
      const rows = Object.entries(map).sort((a, b) => b[1].total - a[1].total);
      const grand = rows.reduce((s, [, v]) => s + v.total, 0);
      el.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Client</th><th># Invoices</th><th>Total Revenue (CAD)</th><th>Avg Invoice (CAD)</th><th>Last Invoice</th><th>% of Revenue</th></tr></thead>
    <tbody>${rows.map(([name, v]) => `<tr>
      <td><strong>${name}</strong></td>
      <td><span class="badge bb">${v.count}</span></td>
      <td class="amt" style="color:var(--green)">$${fmt(v.total)}</td>
      <td class="amt">$${fmt(v.total / v.count)}</td>
      <td>${v.dates.sort().slice(-1)[0] || '‚Äî'}</td>
      <td><div style="display:flex;align-items:center;gap:8px">
        <div style="flex:1;background:#f1f5f9;border-radius:4px;height:6px;overflow:hidden">
          <div style="width:${grand ? (v.total / grand * 100) : 0}%;height:100%;background:var(--accent);border-radius:4px"></div>
        </div>
        <span style="font-size:12px;color:var(--muted)">${grand ? (v.total / grand * 100).toFixed(1) : 0}%</span>
      </div></td>
    </tr>`).join('')}
    </tbody></table></div>`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MODAL ‚Äî view & edit
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showDetail(id) {
      const i = invoices.find(x => x.id === id); if (!i) return;
      document.getElementById('moTitle').textContent = `Invoice ${i.invoiceNumber || i.fileName || ''}`;
      document.getElementById('moContent').innerHTML = `
    <div class="dg">
      <div><div class="dl">Client</div><div class="dv">${i.clientName || '‚Äî'}</div></div>
      <div><div class="dl">Invoice #</div><div class="dv">${i.invoiceNumber || '‚Äî'}</div></div>
      <div><div class="dl">Date</div><div class="dv">${i.date || '‚Äî'}</div></div>
      <div><div class="dl">Period</div><div class="dv">${i.quarter || '‚Äî'} ${i.year || ''} ‚Ä¢ ${i.monthName || ''}</div></div>
      <div><div class="dl">Subtotal</div><div class="dv" style="font-family:Syne;font-weight:700">$${fmt(i.subtotal || 0)}</div></div>
      <div><div class="dl">Tax (HST/GST)</div><div class="dv" style="font-family:Syne;font-weight:700">$${fmt(i.tax || 0)}</div></div>
      <div class="full"><div class="dl">Total</div><div class="dv" style="font-family:Syne;font-weight:800;font-size:22px;color:var(--green)">$${fmt(i.total || 0)} <span style="font-size:13px;font-weight:400;color:var(--muted)">${i.currency || 'CAD'}</span></div></div>
      ${i.paymentMethod ? `<div><div class="dl">Payment Method</div><div class="dv">${i.paymentMethod}</div></div>` : ''}
      ${i.hstNumber ? `<div><div class="dl">HST Number</div><div class="dv" style="font-size:13px;color:var(--muted)">${i.hstNumber}</div></div>` : ''}
      <div class="full"><div class="dl">Source file</div><div class="dv" style="color:var(--muted);font-size:13px">${i.fileName || '‚Äî'}</div></div>
    </div>
    ${i.lineItems && i.lineItems.length ? `<div style="margin-top:18px"><div class="dl" style="margin-bottom:6px">Line Items</div>
      <table class="lit"><thead><tr><th>Description</th><th>Qty</th><th>Unit Price</th><th>Our Price</th><th>Amount</th></tr></thead>
      <tbody>${i.lineItems.map(l => `<tr><td>${l.description || '‚Äî'}</td><td>${l.quantity || '‚Äî'}</td><td>$${fmt(l.unitPrice || 0)}</td><td>$${fmt(l.ourPrice || 0)}</td><td>$${fmt(l.amount || 0)}</td></tr>`).join('')}</tbody>
      </table></div>`: ''}
    <div style="margin-top:18px;display:flex;gap:10px">
      <button class="save-btn" onclick="openEdit('${i.id}')">‚úèÔ∏è Edit this invoice</button>
      <button class="save-btn" style="background:#64748b" onclick="alert(JSON.stringify(invoices.find(x=>x.id==='${i.id}').lineItems, null, 2))">üîç Debug Items</button>
    </div>`;
      document.getElementById('mo').classList.add('open');
    }

    function openEdit(id) {
      const i = invoices.find(x => x.id === id); if (!i) return;
      document.getElementById('moTitle').textContent = `Edit Invoice`;
      document.getElementById('moContent').innerHTML = `
    <div class="dg">
      <div class="full"><div class="dl">Client Name</div><input class="edit-input" id="edit_clientName" value="${i.clientName || ''}"></div>
      <div><div class="dl">Invoice #</div><input class="edit-input" id="edit_invoiceNumber" value="${i.invoiceNumber || ''}"></div>
      <div><div class="dl">Date (YYYY-MM-DD)</div><input class="edit-input" id="edit_date" value="${i.date || ''}"></div>
      <div><div class="dl">Subtotal ($)</div><input class="edit-input" type="number" step="0.01" id="edit_subtotal" value="${i.subtotal || 0}"></div>
      <div><div class="dl">Tax ($)</div><input class="edit-input" type="number" step="0.01" id="edit_tax" value="${i.tax || 0}"></div>
      <div class="full"><div class="dl">Total ($)</div><input class="edit-input" type="number" step="0.01" id="edit_total" value="${i.total || 0}"></div>
    </div>
    
    <div style="margin-top:20px">
      <div class="dl" style="margin-bottom:8px">Line Items Editor</div>
      <table class="lit" id="edit_lineItemsTable">
        <thead><tr><th>Description</th><th style="width:70px">Qty</th><th style="width:90px">Price</th><th style="width:90px">Our Price</th><th style="width:40px"></th></tr></thead>
        <tbody>
          ${(i.lineItems || []).map((l, idx) => `
            <tr data-idx="${idx}">
              <td><input class="edit-input" style="padding:4px" value="${l.description || ''}"></td>
              <td><input class="edit-input" style="padding:4px" type="number" value="${l.quantity || 0}"></td>
              <td><input class="edit-input" style="padding:4px" type="number" step="0.01" value="${l.unitPrice || 0}"></td>
              <td><input class="edit-input" style="padding:4px" type="number" step="0.01" value="${l.ourPrice || 0}"></td>
              <td><button class="icon-btn del" onclick="this.closest('tr').remove()">üóë</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <button class="save-btn" style="background:#64748b; margin-top:8px; padding:6px 14px; font-size:12px" onclick="addEditRow()">+ Add Item</button>
    </div>
    <button class="save-btn" onclick="saveEdit('${i.id}')">üíæ Save Changes</button>
    `;
      document.getElementById('mo').classList.add('open');
    }

    function addEditRow() {
      const tbody = document.querySelector('#edit_lineItemsTable tbody');
      if (!tbody) return;
      const tr = document.createElement('tr');
      tr.innerHTML = '<td><input class="edit-input" style="padding:4px" value=""></td>' +
        '<td><input class="edit-input" style="padding:4px" type="number" value="1"></td>' +
        '<td><input class="edit-input" style="padding:4px" type="number" step="0.01" value="0"></td>' +
        '<td><input class="edit-input" style="padding:4px" type="number" step="0.01" value="0"></td>' +
        '<td><button class="icon-btn del" onclick="this.closest(\'tr\').remove()">üóë</button></td>';
      tbody.appendChild(tr);
    }

    function closeMo(e) { if (e.target === document.getElementById('mo')) closeMoDirect(); }
    function closeMoDirect() { document.getElementById('mo').classList.remove('open'); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FILTERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function populateFilters() {
      const MNAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October',
        'November', 'December'];
      const years = [...new Set(invoices.map(i => i.year).filter(Boolean))].sort((a, b) => b - a);
      const months = [...new Set(invoices.map(i => i.month).filter(Boolean))].sort((a, b) => a - b);
      const yf = document.getElementById('yrFilter'), mf = document.getElementById('moFilter');
      const cy = yf.value, cm = mf.value;
      yf.innerHTML = '<option value="">All years</option>' + years.map(y => `<option value="${y}" ${y == cy ? 'selected' : ''
        }>${y}</option>`).join('');
      mf.innerHTML = '<option value="">All months</option>' + months.map(m => `<option value="${m}" ${m == cm ? 'selected'
        : ''}>${MNAMES[m - 1] || m}</option>`).join('');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // QUEUE UI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function addQueueItem(id, name) {
      const el = document.createElement('div');
      el.className = 'queue-item'; el.id = id;
      el.innerHTML = `<div class="sdot proc" id="sd_${id}"></div><span class="q-filename">üìÑ ${name}</span><span
    class="q-status" id="qs_${id}">Reading PDF...</span>`;
      document.getElementById('queueList').prepend(el);
    }
    function setQStatus(id, status, msg) {
      const sd = document.getElementById('sd_' + id), qs = document.getElementById('qs_' + id);
      if (sd) sd.className = 'sdot ' + status;
      if (qs) qs.textContent = msg;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function fmt(n) {
      return Number(n || 0).toLocaleString('en-US', {
        minimumFractionDigits: 2, maximumFractionDigits: 2
      });
    }
    function fmtK(n) {
      if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M'; if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return fmt(n);
    }
    function emptyHTML(icon, msg) {
      return `<div class="empty">
    <div class="empty-icon">${icon}</div>
    <div class="empty-sub">${msg}</div>
  </div>`;
    }
    function showToast(msg, type = 'ok') {
      const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast ${type} show`;
      setTimeout(() => t.classList.remove('show'), 3200);
    }

    loadData();
  </script>
</body>

</html>